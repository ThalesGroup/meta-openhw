From b15bed4ad496f261818dec39718adce7356a4e39 Mon Sep 17 00:00:00 2001
From: Kevin Eyssartier <kevin.eyssartier@thalesgroup.com>
Date: Tue, 1 Mar 2022 17:29:45 +0100
Subject: Driver-lowrisc: adding realtek phy

---
 arch/riscv/dts/cv64a6_genesysII.dts           |  8 +++++
 .../openhwgroup_cv64a6_genesysII_defconfig    |  6 +++-
 drivers/net/lowrisc/lowrisc_100MHz.c          | 33 +++++++++++++++++--
 3 files changed, 44 insertions(+), 3 deletions(-)

diff --git a/arch/riscv/dts/cv64a6_genesysII.dts b/arch/riscv/dts/cv64a6_genesysII.dts
index b699c7bbb0..7849f43bca 100644
--- a/arch/riscv/dts/cv64a6_genesysII.dts
+++ b/arch/riscv/dts/cv64a6_genesysII.dts
@@ -117,6 +117,13 @@
       //   //interrupt-parent = <&PLIC0>;
       // };
     };
+    mdio {
+		#address-cells = <1>;
+		#size-cells = <0>;
+        ethernet_phy: ethernet-phy@0 { /* Realtek RTL8211E-VL */
+            reg = <0>;
+        };
+    };
     eth: lowrisc-eth@30000000 {
       compatible = "lowrisc-eth";
       device_type = "network";
@@ -124,6 +131,7 @@
       interrupts = <3 0>;
       local-mac-address = [00 18 3e 02 e3 7f]; // This needs to change if more than one GenesysII on a VLAN
       reg = <0x0 0x30000000 0x0 0x8000>;
+      phy-handle = <&ethernet_phy>;
     };
     xlnx_gpio: gpio@40000000 {
       #gpio-cells = <2>;
diff --git a/configs/openhwgroup_cv64a6_genesysII_defconfig b/configs/openhwgroup_cv64a6_genesysII_defconfig
index 56d0210358..f466e2300c 100644
--- a/configs/openhwgroup_cv64a6_genesysII_defconfig
+++ b/configs/openhwgroup_cv64a6_genesysII_defconfig
@@ -14,6 +14,9 @@ CONFIG_CMD_GPT=y
 CONFIG_CMD_MMC=y
 CONFIG_CMD_MTD=y
 CONFIG_CMD_PART=y
+CONFIG_CMD_DHCP=y
+CONFIG_CMD_MDIO=y
+CONFIG_CMD_PING=y
 CONFIG_OF_EMBED=y
 CONFIG_MMC=y
 # CONFIG_MMC_WRITE is not set
@@ -30,9 +33,10 @@ CONFIG_SPI_FLASH_STMICRO=y
 CONFIG_SPI_FLASH_SST=y
 CONFIG_SPI_FLASH_WINBOND=y
 CONFIG_SPI_FLASH_XMC=y
-CONFIG_LOWRISC_DIGILENT_100MHZ=y
 # CONFIG_SPI_FLASH_USE_4K_SECTORS is not set
 CONFIG_SPI_FLASH_MTD=y
+CONFIG_PHY_REALTEK=y
+CONFIG_LOWRISC_DIGILENT_100MHZ=y
 CONFIG_SYS_NS16550=y
 CONFIG_SPI=y
 CONFIG_XILINX_SPI=y
diff --git a/drivers/net/lowrisc/lowrisc_100MHz.c b/drivers/net/lowrisc/lowrisc_100MHz.c
index f9b00b419a..fd6b114b55 100644
--- a/drivers/net/lowrisc/lowrisc_100MHz.c
+++ b/drivers/net/lowrisc/lowrisc_100MHz.c
@@ -652,6 +652,7 @@ static int lowrisc_open(struct udevice *ndev)
  */
 static int lowrisc_send(struct udevice *ndev, void *ptr, int len)
 {
+	printf("lowrisc-eth: send call\n");
     struct net_local *priv = dev_get_priv(ndev);
     int rslt;
 	//~ if (mutex_is_locked(&priv->lock))
@@ -673,9 +674,37 @@ static int lowrisc_send(struct udevice *ndev, void *ptr, int len)
 
 static int lowrisc_recv(struct udevice *dev, int flags, uchar **packetp)
 {
-    // TODO
+    int rsr, buf;
+    struct net_local *priv = dev_get_priv(dev);
+    rsr = eth_read(priv, RSR_OFFSET);
+    buf = rsr & RSR_RECV_FIRST_MASK;
+    /* Check if there is Rx Data available */
+    if (rsr & RSR_RECV_DONE_MASK)
+    {
+        int len = eth_read(priv, RPLR_OFFSET+((buf&7)<<3)) - 4; /* discard FCS bytes ?? */
+        if ((len >= 60) && (len <= ETH_FRAME_LEN + ETH_FCS_LEN))
+        {
+            int start = RXBUFF_OFFSET/8 + ((buf&7)<<8);
+            eth_copyin(priv, *packetp, len, start);
+        }
 
-	return 0; // NETDEV_TX_OK
+        /* acknowledge, even if an error occurs */
+        eth_write(priv, RSR_OFFSET, ++buf);
+        rsr = eth_read(priv, RSR_OFFSET);
+
+        printf("lowrisc-eth: received frame\n");
+        unsigned int* printP = (unsigned int*)(*packetp);
+        printf("0x%X 0x%X 0x%X 0x%X\n", printP[0],printP[1],printP[2],printP[3]);
+    }
+
+    if (rsr & RSR_RECV_DONE_MASK)
+    {
+        return 1;
+    }
+    else
+    {
+        return 0;
+    }
 }
 
 // static int lowrisc_mii_ioctl(struct net_device *netdev, struct ifreq *ifr, int cmd)
-- 
2.25.1

